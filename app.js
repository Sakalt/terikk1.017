// „Ç¢„Ç§„ÉÜ„É†„ÄÅÊïµ„ÄÅÈâ±Áü≥„ÄÅ„Éñ„É≠„ÉÉ„ÇØ„Å™„Å©„ÅÆÂÆöÁæ©
const items = [
    { name: "Ââ£", type: "weapon", attackPower: 15, element: "‚öîÔ∏è" },
    { name: "Âºì", type: "weapon", attackPower: 10, element: "üèπ" },
    { name: "ÂõûÂæ©„Éù„Éº„Ç∑„Éß„É≥", type: "potion", healAmount: 20, element: "üç∑" },
    { name: "„ÉÑ„Éº„É´", type: "tool", effect: "useTool", element: "üîß" },
    { name: "„Éè„É≥„Éû„Éº", type: "tool", effect: "build", element: "üî®" },
    { name: "„Å§„Çã„ÅØ„Åó", type: "tool", effect: "mine", element: "‚õèÔ∏è" },
    { name: "ÊúàÁü≥„ÅÆÂâ£", type: "weapon", attackPower: 30, element: "üåï‚öîÔ∏è" },
    { name: "ÊúàÁü≥„ÅÆÁõæ", type: "armor", defensePower: 20, element: "üåïüõ°Ô∏è" }
];

const ores = [
    { name: "ÈâÑÈâ±Áü≥", hardness: 5, element: "‚õèÔ∏è" },
    { name: "ÈáëÈâ±Áü≥", hardness: 7, element: "‚õèÔ∏è" },
    { name: "„ÉÄ„Ç§„É§Èâ±Áü≥", hardness: 10, element: "‚õèÔ∏è" },
    { name: "ÈäÖÈâ±Áü≥", hardness: 3, element: "‚õèÔ∏è" },
    { name: "ÈäÄÈâ±Áü≥", hardness: 6, element: "‚õèÔ∏è" },
    { name: "ÊúàÁü≥Èâ±Áü≥", hardness: 12, element: "üåï‚õèÔ∏è" }
];

const blocks = [
    { name: "Áü≥", hardness: 2, element: "üß±" },
    { name: "Êú®Êùê", hardness: 1, element: "ü™µ" },
    { name: "Âúü", hardness: 1, element: "üåø" },
    { name: "Á†Ç", hardness: 1, element: "üèñÔ∏è" },
    { name: "„Ç≥„É≥„ÇØ„É™„Éº„Éà", hardness: 4, element: "ü™®" },
    { name: "„Å™„Çì„Åß„ÇÇ„Éñ„É≠„ÉÉ„ÇØ", hardness: 1, element: "üéÅ" },
    { name: "ÈöúÂ£Å", hardness: 100, element: "üß±" }
];

const enemies = [
    { name: "„Ç¥„Éñ„É™„É≥", health: 30, speed: 2, element: "üëπ", poison: false },
    { name: "„Ç¥„Éº„Çπ„Éà", health: 25, speed: 1.5, element: "üëª", poison: false },
    { name: "„Çπ„É©„Ç§„É†", health: 15, speed: 1, element: "ü™≤", poison: true },
    { name: "ÊØíËõá", health: 20, speed: 1.2, element: "üêç", poison: true },
    { name: "„Éâ„É©„Ç¥„É≥", health: 50, speed: 3, element: "üêâ", poison: false }
];

const potions = [
    { name: "ÂõûÂæ©„Éù„Éº„Ç∑„Éß„É≥", healAmount: 20, element: "üç∑" },
    { name: "„Éû„Éä„Éù„Éº„Ç∑„Éß„É≥", manaAmount: 10, element: "üçª" },
    { name: "Âäõ„ÅÆ„Éù„Éº„Ç∑„Éß„É≥", strengthAmount: 5, element: "üí™" },
    { name: "„Çπ„Éî„Éº„Éâ„Éù„Éº„Ç∑„Éß„É≥", speedAmount: 5, element: "üöÄ" },
    { name: "ÊØíÊ∂à„Åó", poisonAmount: -10, element: "üíä" }
];

const accessories = [
    { name: "„É™„É≥„Ç∞", effect: "attackBoost", value: 5, element: "üíç" },
    { name: "Â∏ΩÂ≠ê", effect: "defenseBoost", value: 3, element: "üß¢" },
    { name: "„Éû„É≥„Éà", effect: "speedBoost", value: 5, element: "üß•" }
];

const effects = [
    { name: "Ëºù„Åç", type: "buff", element: "‚ú®" },
    { name: "Á´úÂ∑ª", type: "debuff", element: "üå™Ô∏è" },
    { name: "ÁÖô", type: "debuff", element: "üå´Ô∏è" }
];

// „Éó„É¨„Ç§„É§„Éº„ÅÆÁä∂ÊÖã
let player = {
    hp: 100,
    attackPower: 10,
    defense: 5,
    speed: 2,
    x: 50,
    y: 50,
    invincible: false,
    inventory: [],
    invincibleTimer: null,
    attackSpeed: 1000, // ÊîªÊíÉÈÄüÂ∫¶Ôºà„Éü„É™ÁßíÔºâ
    lastAttackTime: 0
};

// „É≠„Éº„Ç´„É´„Çπ„Éà„É¨„Éº„Ç∏„Å´„Ç≤„Éº„É†Áä∂ÊÖã„Çí‰øùÂ≠ò
function saveGameState() {
    const gameState = {
        player: player,
        items: Array.from(document.querySelectorAll('.item')).map(item => ({
            name: item.dataset.name,
            x: parseFloat(item.style.left),
            y: parseFloat(item.style.bottom)
        })),
        enemies: Array.from(document.querySelectorAll('.enemy')).map(enemy => ({
            name: enemy.dataset.name,
            x: parseFloat(enemy.style.left),
            y: parseFloat(enemy.style.bottom),
            health: parseFloat(enemy.dataset.health)
        }))
    };
    localStorage.setItem('gameState', JSON.stringify(gameState));
}

// „É≠„Éº„Ç´„É´„Çπ„Éà„É¨„Éº„Ç∏„Åã„Çâ„Ç≤„Éº„É†Áä∂ÊÖã„Çí„É≠„Éº„Éâ
function loadGameState() {
    const gameState = JSON.parse(localStorage.getItem('gameState'));
    if (gameState) {
        player = gameState.player;
        gameState.items.forEach(item => {
            const element = document.createElement('div');
            element.classList.add('item');
            element.dataset.name = item.name;
            element.style.left = item.x + 'px';
            element.style.bottom = item.y + 'px';
            element.textContent = items.find(i => i.name === item.name).element;
            document.getElementById('game-container').appendChild(element);
        });
        gameState.enemies.forEach(enemy => {
            const element = document.createElement('div');
            element.classList.add('enemy');
            element.dataset.name = enemy.name;
            element.dataset.health = enemy.health;
            element.style.left = enemy.x + 'px';
            element.style.bottom = enemy.y + 'px';
            element.textContent = enemies.find(e => e.name === enemy.name).element;
            document.getElementById('game-container').appendChild(element);
        });
        updateHpBar();
        updateInventory();
    }
}

// HP„Éê„Éº„ÇíÊõ¥Êñ∞
function updateHpBar() {
    const hpBar = document.querySelector('#hp-bar div');
    hpBar.style.width = (player.hp / 100) * 100 + '%';
}

// „Ç§„É≥„Éô„É≥„Éà„É™„ÇíÊõ¥Êñ∞
function updateInventory() {
    const inventory = document.getElementById('inventory');
    inventory.innerHTML = '';
    player.inventory.forEach(item => {
        const element = document.createElement('div');
        element.classList.add('inventory-item');
        element.textContent = item.element;
        inventory.appendChild(element);
    });
}

// „Ç¢„Ç§„ÉÜ„É†„Çí„É©„É≥„ÉÄ„É†„Å´„Ç§„É≥„Éô„É≥„Éà„É™„Å´ËøΩÂä†
function addRandomItemToInventory() {
    const randomItem = items[Math.floor(Math.random() * items.length)];
    player.inventory.push(randomItem);
    updateInventory();
}

// ÂÖ®„Å¶„ÅÆ„Ç¢„Ç§„ÉÜ„É†„ÇíÊâã„Å´ÂÖ•„Çå„Çã
function giveAllItems() {
    player.inventory = items.slice();
    updateInventory();
}

// Êïµ„Çí„Çπ„Éù„Éº„É≥
function spawnEnemies() {
    const container = document.getElementById('game-container');
    enemies.forEach(enemy => {
        const element = document.createElement('div');
        element.classList.add('enemy');
        element.dataset.name = enemy.name;
        element.dataset.health = enemy.health;
        element.style.left = Math.random() * (container.clientWidth - 40) + 'px';
        element.style.bottom = Math.random() * (container.clientHeight - 40) + 'px';
        element.textContent = enemy.element;
        container.appendChild(element);
    });
}

// „Éó„É¨„Ç§„É§„Éº„ÅÆÁßªÂãï
function movePlayer(dx, dy) {
    const container = document.getElementById('game-container');
    player.x = Math.max(0, Math.min(container.clientWidth - 50, player.x + dx));
    player.y = Math.max(0, Math.min(container.clientHeight - 50, player.y + dy));
    const playerElement = document.getElementById('player');
    playerElement.style.left = player.x + 'px';
    playerElement.style.bottom = player.y + 'px';
}

// „Éó„É¨„Ç§„É§„Éº„ÅÆÊîªÊíÉ
function attack() {
    const now = Date.now();
    if (now - player.lastAttackTime < player.attackSpeed) return; // ÊîªÊíÉÈÄüÂ∫¶„ÅÆÂà∂Âæ°
    player.lastAttackTime = now;

    const playerElement = document.getElementById('player');
    const playerRect = playerElement.getBoundingClientRect();

    document.querySelectorAll('.enemy').forEach(enemyElement => {
        const enemyRect = enemyElement.getBoundingClientRect();
        if (
            enemyRect.left < playerRect.right &&
            enemyRect.right > playerRect.left &&
            enemyRect.top < playerRect.bottom &&
            enemyRect.bottom > playerRect.top
        ) {
            const enemyName = enemyElement.dataset.name;
            const enemyData = enemies.find(e => e.name === enemyName);
            enemyElement.dataset.health -= player.attackPower;

            // „Ç®„Éï„Çß„ÇØ„Éà„ÇíËøΩÂä†
            const effectElement = document.createElement('div');
            effectElement.classList.add('effect');
            effectElement.textContent = '‚ú®';
            effectElement.style.left = enemyElement.style.left;
            effectElement.style.bottom = enemyElement.style.bottom;
            document.getElementById('game-container').appendChild(effectElement);
            setTimeout(() => effectElement.remove(), 500);

            if (enemyElement.dataset.health <= 0) {
                enemyElement.remove();
            }
        }
    });
}

// „Éó„É¨„Ç§„É§„Éº„Åå„ÉÄ„É°„Éº„Ç∏„ÇíÂèó„Åë„Çã
function takeDamage(amount) {
    if (player.invincible) return; // ÁÑ°ÊïµÊôÇÈñì‰∏≠„ÅØ„ÉÄ„É°„Éº„Ç∏„ÇíÂèó„Åë„Å™„ÅÑ
    player.hp -= amount;
    if (player.hp <= 0) {
        alert('„Ç≤„Éº„É†„Ç™„Éº„Éê„Éº');
        player.hp = 100;
        player.x = 50;
        player.y = 50;
    }
    updateHpBar();
    activateInvincibility(0.6); // ÊîªÊíÉÂæå„ÅÆÁÑ°ÊïµÊôÇÈñì
}

// ÁÑ°ÊïµÊôÇÈñì„ÇíÊúâÂäπÂåñ
function activateInvincibility(duration) {
    player.invincible = true;
    clearTimeout(player.invincibleTimer);
    player.invincibleTimer = setTimeout(() => player.invincible = false, duration * 1000);
}

// „Ç≤„Éº„É†„ÅÆÂàùÊúüÂåñ
function initGame() {
    document.getElementById('player').style.left = player.x + 'px';
    document.getElementById('player').style.bottom = player.y + 'px';
    updateHpBar();
    updateInventory();
    spawnEnemies();
}

// ÂàùÊúüÂåñÈñ¢Êï∞„ÅÆÂëº„Å≥Âá∫„Åó
initGame();

// „Ç≤„Éº„É†Áä∂ÊÖã„ÅÆ‰øùÂ≠ò
window.addEventListener('beforeunload', saveGameState);

// „Éó„É¨„Ç§„É§„Éº„ÅÆÁßªÂãï„Å®ÊîªÊíÉ„ÅÆÂá¶ÁêÜ
document.addEventListener('keydown', event => {
    switch (event.key) {
        case 'ArrowUp':
            movePlayer(0, player.speed);
            break;
        case 'ArrowDown':
            movePlayer(0, -player.speed);
            break;
        case 'ArrowLeft':
            movePlayer(-player.speed, 0);
            break;
        case 'ArrowRight':
            movePlayer(player.speed, 0);
            break;
        case ' ':
            attack();
            break;
    }
});

// „Ç≤„Éº„É†„ÅÆË™≠„ÅøËæº„Åø
window.addEventListener('load', loadGameState);

// „ÇØ„É©„Éï„Éà„É¨„Ç∑„Éî„ÅÆÂÆöÁæ©
const craftingRecipes = [
    { 
        name: "ÈâÑ„ÅÆÂâ£", 
        ingredients: [{ name: "ÈâÑÈâ±Áü≥", quantity: 2 }, { name: "Êú®Êùê", quantity: 1 }], 
        result: { name: "ÈâÑ„ÅÆÂâ£", type: "weapon", attackPower: 20, element: "‚öîÔ∏è" } 
    },
    { 
        name: "Èáë„ÅÆÂºì", 
        ingredients: [{ name: "ÈáëÈâ±Áü≥", quantity: 2 }, { name: "Êú®Êùê", quantity: 1 }], 
        result: { name: "Èáë„ÅÆÂºì", type: "weapon", attackPower: 15, element: "üèπ" } 
    },
    { 
        name: "ÊúàÁü≥„ÅÆÂâ£", 
        ingredients: [{ name: "ÊúàÁü≥Èâ±Áü≥", quantity: 2 }, { name: "Êú®Êùê", quantity: 1 }], 
        result: { name: "ÊúàÁü≥„ÅÆÂâ£", type: "weapon", attackPower: 30, element: "üåï‚öîÔ∏è" } 
    }
];

// „ÇØ„É©„Éï„Éà„É°„Éã„É•„Éº„ÅÆË°®Á§∫
function toggleCraftingMenu() {
    const menu = document.getElementById('crafting-menu');
    menu.style.display = menu.style.display === 'block' ? 'none' : 'block';
    updateCraftingRecipes();
}

// „ÇØ„É©„Éï„Éà„É¨„Ç∑„Éî„ÅÆÊõ¥Êñ∞
function updateCraftingRecipes() {
    const recipeList = document.getElementById('crafting-recipes');
    recipeList.innerHTML = '';
    craftingRecipes.forEach(recipe => {
        const listItem = document.createElement('li');
        listItem.textContent = recipe.name;
        listItem.onclick = () => craftItem(recipe);
        recipeList.appendChild(listItem);
    });
}

// „Ç¢„Ç§„ÉÜ„É†„ÅÆ„ÇØ„É©„Éï„Éà
function craftItem(recipe) {
    const canCraft = recipe.ingredients.every(ingredient => {
        const inventoryItem = player.inventory.find(item => item.name === ingredient.name);
        return inventoryItem && inventoryItem.quantity >= ingredient.quantity;
    });
    if (canCraft) {
        recipe.ingredients.forEach(ingredient => {
            const inventoryItem = player.inventory.find(item => item.name === ingredient.name);
            inventoryItem.quantity -= ingredient.quantity;
            if (inventoryItem.quantity <= 0) {
                player.inventory = player.inventory.filter(item => item.name !== ingredient.name);
            }
        });
        player.inventory.push(recipe.result);
        updateInventory();
        alert(`${recipe.name}„Çí„ÇØ„É©„Éï„Éà„Åó„Åæ„Åó„ÅüÔºÅ`);
    } else {
        alert('ÊùêÊñô„Åå‰∏çË∂≥„Åó„Å¶„ÅÑ„Åæ„Åô');
    }
}

// ÊîªÊíÉÂá¶ÁêÜ„ÅÆËøΩÂä†
function attack() {
    if (Date.now() - player.lastAttackTime >= player.attackSpeed) {
        console.log('ÊîªÊíÉÔºÅ');
        player.lastAttackTime = Date.now();
        // ÊîªÊíÉÂá¶ÁêÜ„Çí„Åì„Åì„Å´ÂÆüË£Ö
        const enemies = document.querySelectorAll('.enemy');
        enemies.forEach(enemy => {
            const enemyRect = enemy.getBoundingClientRect();
            const playerRect = document.getElementById('player').getBoundingClientRect();
            if (
                playerRect.left < enemyRect.right &&
                playerRect.right > enemyRect.left &&
                playerRect.top < enemyRect.bottom &&
                playerRect.bottom > enemyRect.top
            ) {
                enemy.dataset.health -= player.attackPower;
                if (enemy.dataset.health <= 0) {
                    enemy.remove();
                }
            }
        });
    }
}

// „Ç¢„Ç§„ÉÜ„É†„ÅÆËøΩÂä†„Éú„Çø„É≥Ê©üËÉΩ
function addRandomItemToInventory() {
    const allItems = [...items, ...ores, ...blocks, ...potions, ...accessories];
    const randomItem = allItems[Math.floor(Math.random() * allItems.length)];
    const existingItem = player.inventory.find(item => item.name === randomItem.name);
    if (existingItem) {
        existingItem.quantity++;
    } else {
        player.inventory.push({ ...randomItem, quantity: 1 });
    }
    updateInventory();
}

function giveAllItems() {
    const allItems = [...items, ...ores, ...blocks, ...potions, ...accessories];
    allItems.forEach(item => {
        const existingItem = player.inventory.find(invItem => invItem.name === item.name);
        if (existingItem) {
            existingItem.quantity++;
        } else {
            player.inventory.push({ ...item, quantity: 1 });
        }
    });
    updateInventory();
}

// ÂàùÊúüÂåñÈñ¢Êï∞„Åß„ÇØ„É©„Éï„Éà„É¨„Ç∑„Éî„ÅÆÊõ¥Êñ∞„ÇíÂëº„Å≥Âá∫„Åô
function initGame() {
    loadGameState();
    resetJoysticks();
    updateCraftingRecipes(); // „ÇØ„É©„Éï„Éà„É¨„Ç∑„Éî„ÅÆÊõ¥Êñ∞
}
